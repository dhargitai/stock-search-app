# Story 1.3: Integrate Alphavantage API for Type-Ahead Suggestions

## Status
Approved

## Story
**As a** User,
**I want** to see a list of matching stocks as I type in the search bar,
**so that** I can quickly find the symbol I'm looking for.

## Acceptance Criteria
1. As the user types (after a debounce interval), a tRPC endpoint is called.
2. The tRPC endpoint fetches data from the Alphavantage `SYMBOL_SEARCH` API.
3. The fetched suggestions (symbol and name) are displayed in a list below the search input.
4. Clicking a suggestion navigates the user to the stock detail page for that symbol.
5. API requests are cached using React Query to prevent redundant calls.

## Tasks / Subtasks
- [ ] Update tRPC stock router to integrate real Alphavantage API (AC: 1, 2)
  - [ ] Implement `SYMBOL_SEARCH` API call in `apps/web/src/server/api/routers/stock.ts`
  - [ ] Add proper environment variable handling for `ALPHA_VANTAGE_API_KEY`
  - [ ] Add structured error handling with tRPC error codes
  - [ ] Update input validation to match Alphavantage API requirements
- [ ] Update SearchInput component to use tRPC query (AC: 1, 5)
  - [ ] Replace mock suggestions with `api.stock.search.useQuery` tRPC hook
  - [ ] Implement debounce functionality (300ms delay)
  - [ ] Add loading states for API calls
  - [ ] Handle error states gracefully with user feedback
- [ ] Implement navigation to stock detail page (AC: 4)
  - [ ] Update suggestion click handler to navigate to `/[symbol]` route
  - [ ] Use Next.js `useRouter` for navigation
  - [ ] Ensure proper URL encoding for stock symbols
- [ ] Write comprehensive unit and integration tests
  - [ ] Test tRPC stock search endpoint with mocked Alphavantage API
  - [ ] Test SearchInput component with real tRPC integration
  - [ ] Test debounce functionality and caching behavior
  - [ ] Test navigation functionality on suggestion clicks
  - [ ] Test error handling and loading states

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 Dev Agent Record]
- SearchInput component exists with mock suggestions and proper accessibility attributes
- Component uses TypeScript strict typing with proper interfaces
- DaisyUI styling implemented with responsive design
- Testing framework configured and ready for component tests
- tRPC infrastructure already established with placeholder stock router

### Tech Stack Requirements
[Source: architecture/3-tech-stack.md]
- **API Layer**: tRPC 11.x for end-to-end type safety between server and client
- **Client State**: React Query 5.x for managing server state, caching, and data fetching
- **Language**: TypeScript 5.x with strict type safety enforcement
- **Testing**: Vitest and React Testing Library for unit and integration tests

### API Specifications
[Source: architecture/6-api-specification-trpc.md]

**tRPC Stock Router Structure:**
- Location: `apps/web/src/server/api/routers/stock.ts`
- Uses `publicProcedure` (no authentication required)
- Input validation with zod schema: `z.object({ query: z.string().min(1) })`
- Return type should be: `{ symbol: string, name: string }[]`

**Expected Alphavantage SYMBOL_SEARCH API Integration:**
- API Key from environment variable: `ALPHA_VANTAGE_API_KEY`
- API Endpoint: `https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords={query}&apikey={key}`
- Response format includes `bestMatches` array with `1. symbol` and `2. name` fields
- Transform response to match tRPC return type format

### Data Models
[Source: architecture/5-data-models-database-schema.md]
No database interaction required for this API integration story. Future stories will cache stock data using dedicated StockData model for performance optimization.

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- tRPC Router: `apps/web/src/server/api/routers/stock.ts` (update existing)
- SearchInput Component: `apps/web/src/components/ui/search-input.tsx` (update existing)
- tRPC Client Setup: `apps/web/src/lib/trpc.ts` (already configured)
- Test files: Colocated with components in `__tests__` directories

### Coding Standards Requirements
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety Paramount**: All functions and variables must have explicit types, `any` type forbidden
- **Environment Variables**: Access only through centralized configuration module, never `process.env` directly
- **API Interaction**: All data fetching must be done through tRPC hooks (`api.stock.search.useQuery`)
- **Error Handling**: All tRPC procedures must include structured error handling and return specific tRPC error codes
- **Client Component Architecture**: SearchInput already properly marked as Client Component, maintain this boundary

### Environment Variables
[Source: .env.example]
- `ALPHA_VANTAGE_API_KEY=""` - Required for Alphavantage API access
- Environment variable must be accessed through server-side code only (tRPC procedure)

### Project Structure Notes
- Current project structure aligns perfectly with architecture specifications
- tRPC infrastructure already established with placeholder implementation
- SearchInput component ready for integration with real API data
- React Query already configured for caching functionality

## Testing
[Source: architecture/9-testing-strategy.md]

**Unit Test Requirements:**
- Test files should be colocated with components in `__tests__` directories
- Use Vitest and React Testing Library for component testing
- Mock tRPC procedures for component tests using `@trpc/react-query/server`

**Integration Test Requirements:**
- Test tRPC procedures to ensure correct interaction with external Alphavantage API
- Use mocking for external API calls to ensure reliable test execution
- Test caching behavior with React Query integration
- Verify proper error handling for API failures and rate limits

**Specific Test Cases:**
- tRPC stock.search procedure with valid and invalid inputs
- SearchInput component debounce functionality (300ms delay)
- Navigation behavior on suggestion selection
- Loading and error state handling in SearchInput
- React Query caching behavior for repeated queries

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation with full architecture context | David (dev) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results