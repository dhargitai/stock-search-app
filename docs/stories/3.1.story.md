# Story 3.1: Implement "Add/Remove from Watchlist" UI

## Status
Done

## Story
**As a** Authenticated User,
**I want** to be able to add or remove stocks from my watchlist directly from the detail page,
**so that** I can easily manage my list.

## Acceptance Criteria
1. On the stock detail page, an authenticated user sees an "Add to Watchlist" button.
2. If the stock is already in their watchlist, the button appears as "Remove from Watchlist".
3. Clicking the button calls the appropriate `addToWatchlist` or `removeFromWatchlist` tRPC endpoint.
4. The UI updates optimistically via React Query and re-fetches to confirm the state.
5. Guest users see a "Login to Add to Watchlist" button that directs them to the login page.

## Tasks / Subtasks
- [x] Add `isInWatchlist` check endpoint to watchlist tRPC router (AC: 2)
  - [x] Create protectedProcedure query endpoint `check` in `apps/web/src/server/api/routers/watchlist.ts`
  - [x] Accept `symbol` string input with validation (min 1, max 10 chars, uppercase transform)
  - [x] Query database for existing watchlist item with `userId_symbol` composite key
  - [x] Return boolean indicating if stock is in user's watchlist
  - [x] Include proper error handling with tRPC error codes
- [x] Create WatchlistButton client component (AC: 1, 2, 3, 4, 5)
  - [x] Create `apps/web/src/components/ui/watchlist-button.tsx` as client component
  - [x] Use `'use client'` directive for interactivity
  - [x] Accept `symbol` prop (string) for the stock symbol
  - [x] Implement useAuth hook for authentication state checking
  - [x] Use tRPC hooks: `api.watchlist.check.useQuery`, `api.watchlist.add.useMutation`, `api.watchlist.remove.useMutation`
  - [x] Implement conditional button text logic based on auth state and watchlist status
  - [x] Style with DaisyUI button classes (btn, btn-primary, btn-outline) and TailwindCSS only
  - [x] Handle loading states during API calls with appropriate button disabled state
  - [x] Implement optimistic updates using React Query's mutation options
  - [x] Add proper TypeScript types for all props and state
  - [x] Handle error states with appropriate user feedback
- [x] Integrate WatchlistButton into stock detail page (AC: 1, 2, 3, 4, 5)
  - [x] Import WatchlistButton component in `apps/web/src/app/[symbol]/page.tsx`
  - [x] Add component in appropriate location within the header section
  - [x] Pass the stock symbol prop from page params
  - [x] Ensure component is positioned near stock title/company name for good UX
- [x] Write comprehensive component tests (AC: 1, 2, 3, 4, 5)
  - [x] Create `apps/web/src/components/ui/__tests__/watchlist-button.test.tsx`
  - [x] Test authenticated user sees "Add to Watchlist" when stock not in watchlist
  - [x] Test authenticated user sees "Remove from Watchlist" when stock is in watchlist
  - [x] Test guest user sees "Login to Add to Watchlist" button
  - [x] Test button click calls appropriate tRPC mutation (add/remove)
  - [x] Test optimistic UI updates during mutation
  - [x] Test error handling and loading states
  - [x] Mock tRPC hooks and useAuth hook for isolated testing
  - [x] Ensure all tests use Vitest and React Testing Library

## Dev Notes

### Previous Story Insights
[Source: Story 2.4 Dev Agent Record]
- RLS policies successfully implemented on watchlist_items table with `auth.uid() = userId` pattern
- tRPC watchlist router has comprehensive CRUD operations: `get`, `add`, `remove` with protectedProcedure
- All watchlist operations use `userId_symbol` composite key for efficient queries
- Comprehensive test coverage exists for server-side watchlist operations
- Database operations properly validated with proper error handling and tRPC error codes

### Data Models
[Source: architecture/5-data-models-database-schema.md]
- **WatchlistItem Table**: Uses composite unique key `userId_symbol` for efficient lookups
- **Symbol Field**: VARCHAR(10) with uppercase normalization, represents stock ticker symbols
- **UserId Field**: UUID referencing authenticated user from Supabase Auth
- **CreatedAt Field**: Timestamp for ordering watchlist items by recency

### API Specifications
[Source: apps/web/src/server/api/routers/watchlist.ts]
- **Existing Endpoints**: 
  - `get` - Retrieves all user's watchlist items (protectedProcedure query)
  - `add` - Adds stock to watchlist (protectedProcedure mutation with symbol input)
  - `remove` - Removes stock from watchlist (protectedProcedure mutation with symbol input)
- **Missing Endpoint**: Need to create `check` endpoint to determine if stock is in watchlist
- **Input Validation**: Symbol inputs use `z.string().min(1).max(10).transform(val => val.toUpperCase())`
- **Error Handling**: Uses specific tRPC error codes (CONFLICT, NOT_FOUND, INTERNAL_SERVER_ERROR)
- **Database Operations**: All operations use Prisma client with `userId_symbol` composite keys

### Component Specifications
[Source: architecture/3-tech-stack.md, 10-coding-standards.md]
- **Client Components**: Must use `'use client'` directive for interactive components with hooks
- **Styling Requirements**: DaisyUI + TailwindCSS classes only, no custom CSS or inline styles
- **State Management**: React Query (via tRPC) for server state, minimal local component state
- **Authentication Integration**: Use existing `useAuth` hook from `apps/web/src/hooks/useAuth.ts`
- **Type Safety**: All props, state, and functions must have explicit TypeScript types

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- **New Component**: `apps/web/src/components/ui/watchlist-button.tsx`
- **Integration Point**: `apps/web/src/app/[symbol]/page.tsx` (stock detail page)
- **tRPC Router**: `apps/web/src/server/api/routers/watchlist.ts` (add check endpoint)
- **Component Tests**: `apps/web/src/components/ui/__tests__/watchlist-button.test.tsx`

### Technical Constraints
[Source: architecture/7-authentication.md, 10-coding-standards.md]
- **Authentication Flow**: Client-side auth state via `useAuth` hook, server-side verification via tRPC protectedProcedure
- **tRPC Integration**: Must use tRPC hooks for API calls, no direct fetch calls allowed
- **Optimistic Updates**: Use React Query's mutation options for immediate UI feedback
- **Error Handling**: All mutations must include comprehensive error handling with user-friendly messages
- **Performance**: Minimize client component boundaries, keep authentication checks efficient

### Testing Requirements
[Source: architecture/9-testing-strategy.md]
- **Testing Framework**: Vitest with React Testing Library for component tests
- **Test Location**: `apps/web/src/components/ui/__tests__/watchlist-button.test.tsx`
- **Mocking Strategy**: Mock tRPC hooks and useAuth hook for isolated component testing
- **Test Coverage**: Must test all user scenarios (authenticated/guest) and all button states
- **Integration Testing**: Test API interactions through mocked tRPC procedures

### Specific Testing Requirements for This Story
- Test component renders correctly for authenticated users with stock not in watchlist
- Test component renders correctly for authenticated users with stock already in watchlist  
- Test component renders correctly for guest users
- Test button click handlers call appropriate tRPC mutations
- Test optimistic UI updates during add/remove operations
- Test loading states during API calls
- Test error handling and user feedback for failed operations
- Test navigation behavior for guest users clicking "Login to Add to Watchlist"

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation | David Hargitai (dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
None required - implementation proceeded smoothly without debugging issues.

### Completion Notes List
1. Successfully added `check` endpoint to watchlist tRPC router with proper validation and error handling
2. Created WatchlistButton component with all required functionality:
   - Authentication state handling via useAuth hook
   - Conditional UI based on authentication and watchlist status
   - Optimistic updates using React Query mutation options
   - Proper error handling and loading states
   - DaisyUI styling following project standards
3. Integrated WatchlistButton into stock detail page header section with proper positioning
4. Implemented comprehensive test coverage (16 tests) covering all user scenarios:
   - Guest user behavior and navigation to login
   - Authenticated user add/remove functionality
   - Loading states and optimistic updates
   - Error handling scenarios
   - Proper mocking of tRPC hooks and authentication
5. All tests passing, type checking successful, linting clean

### File List
- **Modified**: `apps/web/src/server/api/routers/watchlist.ts` - Added `check` endpoint
- **Created**: `apps/web/src/components/ui/watchlist-button.tsx` - New WatchlistButton component
- **Modified**: `apps/web/src/app/[symbol]/page.tsx` - Integrated WatchlistButton
- **Created**: `apps/web/src/components/ui/__tests__/watchlist-button.test.tsx` - Comprehensive test suite

## QA Results

### Review Date: 2025-09-04

### Reviewed By: David Hargitai (dev)

### Code Quality Assessment

Good implementation quality across all components. The code demonstrates excellent adherence to architectural patterns, proper separation of concerns, and comprehensive error handling. All acceptance criteria have been fully implemented with production-ready code quality.

### Refactoring Performed

No refactoring was required. The implementation is already following best practices with:
- Proper TypeScript typing throughout
- Clean component architecture with minimal client boundaries
- Efficient tRPC integration
- Well-structured test coverage

### Compliance Check

- Coding Standards: ✓ Full compliance with all coding standards
- Project Structure: ✓ Proper file organization and component placement
- Testing Strategy: ✓ Comprehensive test coverage (16 tests) covering all scenarios
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and tested

### Improvements Checklist

All quality requirements have been met. Implementation is production-ready.

- [x] tRPC router endpoint properly implemented with validation
- [x] Client component with proper authentication integration
- [x] Optimistic UI updates with error handling
- [x] Comprehensive test coverage for all user scenarios
- [x] Proper styling with DaisyUI/TailwindCSS
- [x] Integration seamlessly added to stock detail page

### Security Review

✓ **PASS** - All security requirements properly implemented:
- Authentication checks via `useAuth` hook
- Server-side protection via `protectedProcedure`
- RLS policies enforced at database level
- Proper input validation and sanitization

### Performance Considerations

✓ **PASS** - Performance optimized implementation:
- Efficient database queries using composite keys
- Proper React Query integration with optimistic updates
- Minimal client component boundaries preserving SSR benefits
- Database operations with proper indexing on `userId_symbol`

### Files Modified During Review

No files were modified during review - implementation quality was already production-ready.

### Gate Status

Gate: PASS → docs/qa/gates/3.1-implement-add-remove-from-watchlist-ui.yml

### Recommended Status

✅ **Ready for Done** - Implementation exceeds quality standards and is production-ready.