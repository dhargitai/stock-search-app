# Story 2.1: Setup Supabase Project & Database Schema

## Status
Done

## Story
**As a** Developer,
**I want** the Supabase project and database schema configured,
**so that** user and watchlist data can be stored.

## Acceptance Criteria
1. A new Supabase project is created.
2. Prisma is connected to the Supabase PostgreSQL database.
3. A Prisma schema is defined for a `WatchlistItem` table, linking stock symbols to a `userId`.
4. The initial database migration is created and applied using `prisma migrate`.

## Tasks / Subtasks
- [x] Setup new Supabase project and obtain connection strings (AC: 1)
  - [x] Create Supabase project via dashboard or CLI
  - [x] Obtain DATABASE_URL and DIRECT_URL connection strings
  - [x] Configure project settings for authentication and database
- [x] Configure environment variables for database connections (AC: 2)
  - [x] Add DATABASE_URL to environment variables
  - [x] Add DIRECT_URL for migrations to environment variables
  - [x] Update .env.example with required variables
- [x] Update Prisma schema for Supabase Auth integration (AC: 3)
  - [x] Configure User model to align with Supabase auth.users table
  - [x] Define WatchlistItem model with userId and symbol fields
  - [x] Add proper UUID configuration and unique constraint on [userId, symbol]
- [x] Create database trigger for User sync with auth.users (AC: 2, 3)
  - [x] Write SQL trigger to auto-create User records on Supabase Auth signup
  - [x] Apply trigger via Supabase dashboard or SQL editor
  - [x] Test trigger functionality with test user creation
- [x] Generate and apply initial database migration (AC: 4)
  - [x] Run `prisma migrate dev --name init` to create migration
  - [x] Verify migration files are created in packages/db/prisma/migrations
  - [x] Apply migration to Supabase database
- [x] Verify database connectivity and schema (AC: 2, 4)
  - [x] Test Prisma client connection to database
  - [x] Verify all tables are created correctly
  - [x] Run basic CRUD operations to confirm setup
- [x] Write integration tests for database setup
  - [x] Test database connection and basic operations
  - [x] Test User model CRUD operations
  - [x] Test Watchlist and WatchlistStock model operations

## Dev Notes

### Previous Story Insights
[Source: Story 1.6 Dev Agent Record]
- The project uses a comprehensive tech stack with Next.js 15, TypeScript, tRPC, and Prisma
- Current development follows strict type safety and coding standards
- Multi-tier caching and performance optimization patterns are established
- Testing strategy uses Vitest and React Testing Library

### Data Models & Database Schema
[Source: architecture/5-data-models-database-schema.md]
- **Schema Design**: Following YAGNI principle, using simple User and WatchlistItem models as specified in architecture
- **User Model Configuration**: Aligns with Supabase's auth.users table using UUID primary keys
- **WatchlistItem Model**: Simple table with userId, symbol, and createdAt fields
- **Database Trigger**: Required to automatically create User records when users sign up via Supabase Auth
- **Connection URLs**: Requires both DATABASE_URL and DIRECT_URL for migrations and connection pooling

### Supabase Authentication Integration
[Source: architecture/7-authentication.md]
- **Client-Server Distinction**: Frontend uses @supabase/ssr for session management
- **Backend Database Access**: tRPC procedures use Prisma client with direct database connection
- **Auth Flow**: One-time code via email using Supabase Auth
- **Session Management**: Cookie-based sessions handled by Supabase client
- **Database Sync**: Database trigger ensures User records sync with auth.users table

### Technology Stack Requirements
[Source: architecture/3-tech-stack.md]
- **Database**: PostgreSQL 15.x via Supabase
- **ORM**: Prisma 6.15.x for type-safe database operations
- **Authentication**: Supabase Auth latest version
- **Framework**: Next.js 15.x with TypeScript 5.x
- **Package Manager**: pnpm with workspace configuration

### Project Structure Alignment
[Source: architecture/4-monorepo-project-structure.md]
- **Database Package**: `packages/db/` contains Prisma schema and generated client
- **Schema Location**: `packages/db/prisma/schema.prisma`
- **Migration Location**: `packages/db/prisma/migrations/`
- **Generated Client**: Output to `packages/db/src/generated/` directory
- **Server Integration**: Accessed via `apps/web/src/server/db.ts`

### Coding Standards Requirements
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety**: All database operations must be explicitly typed
- **Environment Variables**: Access through centralized configuration, never direct process.env
- **Database Operations**: All interactions through Prisma client only, no raw SQL
- **Error Handling**: Structured error handling in tRPC procedures
- **YAGNI Principle**: Schema follows YAGNI by only including User and WatchlistItem models (no premature optimization with Portfolio, StockData, or complex Watchlist structures)

### Testing Requirements
[Source: architecture/9-testing-strategy.md]
- **Integration Tests**: Test tRPC procedures with Prisma client interactions
- **Database Mocking**: Use mocking for database operations in tests
- **Test Location**: Database tests in appropriate test directories
- **Unit Tests**: Test individual database operations and model validations
- **Test Framework**: Vitest for all database operation testing

### Project Structure Notes
Prisma schema follows the architecture specification with minimal models per YAGNI:
- User model with UUID primary key for Supabase Auth compatibility
- WatchlistItem model for simple userId-to-symbol mapping
- No unnecessary tables (Portfolio, StockData, etc.) that aren't required for current epics

## Testing
[Source: architecture/9-testing-strategy.md]

**Integration Test Requirements:**
- Test database connection establishment with Supabase
- Verify Prisma client generation and functionality
- Test User model CRUD operations with proper UUID handling
- Test WatchlistItem model CRUD operations and unique constraints
- Verify database trigger functionality for User sync
- Test migration application and schema validation

**Unit Test Coverage:**
- Database connection configuration
- Prisma schema validation
- Environment variable configuration
- Model relationship integrity
- Error handling for connection failures

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Prisma schema updated from CUID to UUID for Supabase Auth compatibility
- Database trigger implemented for automatic User record creation
- Integration tests created and passing (11 tests)
- Type checking resolved for tRPC User router
- Schema simplified to YAGNI requirements: removed Portfolio, PortfolioHolding, Watchlist, WatchlistStock, and StockData models
- Updated to use direct WatchlistItem model with User relationship

### Completion Notes
✅ **Database Setup**: Supabase project configured with local development environment
✅ **Schema Migration**: Prisma schema follows architecture spec with User and WatchlistItem models only
✅ **Database Trigger**: Automatic User creation on Supabase Auth signup implemented and tested
✅ **Environment Configuration**: DIRECT_URL added for migrations, environment variables properly configured
✅ **Integration Tests**: Comprehensive test suite covering all database models and relationships
✅ **Type Safety**: All tRPC procedures updated to support UUID-based User identification
✅ **Code Quality**: Linting and type checking passing

### File List
**Modified Files:**
- `packages/db/prisma/schema.prisma` - Updated User model for UUID compatibility, added DIRECT_URL, and simplified to YAGNI requirements with only User and WatchlistItem models
- `packages/db/.env` - Added environment variables for database connections
- `apps/web/.env.local` - Added DIRECT_URL for migrations
- `.env.example` - Updated with DIRECT_URL requirement
- `apps/web/src/server/api/routers/user.ts` - Updated for UUID-based User operations and simplified schema
- `packages/db/package.json` - Added Vitest dependency and test scripts
- `packages/db/tests/database.test.ts` - Updated tests for simplified schema structure

**New Files:**
- `packages/db/supabase-user-trigger.sql` - SQL trigger for User sync with auth.users
- `packages/db/tests/database.test.ts` - Comprehensive integration tests
- `packages/db/vitest.config.ts` - Vitest configuration for database tests
- `packages/db/prisma/migrations/001_init/migration.sql` - Simplified migration with User and WatchlistItem tables only

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation with comprehensive Supabase and database setup context | David Hargitai (dev) |
| 2025-09-03 | 1.1 | Implementation completed - Supabase project setup, database schema migration, trigger implementation, and comprehensive testing | David Hargitai (dev) |
| 2025-09-04 | 1.2 | Documentation corrected to reflect YAGNI-compliant schema per architecture specification | David Hargitai (dev) |
| 2025-09-04 | 1.3 | Schema simplified to YAGNI requirements: removed unnecessary tables, kept only User and WatchlistItem models, updated tests and tRPC routers | David Hargitai (dev) |