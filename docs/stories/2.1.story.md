# Story 2.1: Setup Supabase Project & Database Schema

## Status
Approved

## Story
**As a** Developer,
**I want** the Supabase project and database schema configured,
**so that** user and watchlist data can be stored.

## Acceptance Criteria
1. A new Supabase project is created.
2. Prisma is connected to the Supabase PostgreSQL database.
3. A Prisma schema is defined for a `Watchlist` table, linking stocks to a `userId`.
4. The initial database migration is created and applied using `prisma migrate`.

## Tasks / Subtasks
- [ ] Setup new Supabase project and obtain connection strings (AC: 1)
  - [ ] Create Supabase project via dashboard or CLI
  - [ ] Obtain DATABASE_URL and DIRECT_URL connection strings
  - [ ] Configure project settings for authentication and database
- [ ] Configure environment variables for database connections (AC: 2)
  - [ ] Add DATABASE_URL to environment variables
  - [ ] Add DIRECT_URL for migrations to environment variables
  - [ ] Update .env.example with required variables
- [ ] Update Prisma schema for Supabase Auth integration (AC: 3)
  - [ ] Configure User model to align with Supabase auth.users table
  - [ ] Ensure Watchlist and WatchlistStock models match requirements
  - [ ] Add proper UUID configuration and constraints
- [ ] Create database trigger for User sync with auth.users (AC: 2, 3)
  - [ ] Write SQL trigger to auto-create User records on Supabase Auth signup
  - [ ] Apply trigger via Supabase dashboard or SQL editor
  - [ ] Test trigger functionality with test user creation
- [ ] Generate and apply initial database migration (AC: 4)
  - [ ] Run `prisma migrate dev --name init` to create migration
  - [ ] Verify migration files are created in packages/db/prisma/migrations
  - [ ] Apply migration to Supabase database
- [ ] Verify database connectivity and schema (AC: 2, 4)
  - [ ] Test Prisma client connection to database
  - [ ] Verify all tables are created correctly
  - [ ] Run basic CRUD operations to confirm setup
- [ ] Write integration tests for database setup
  - [ ] Test database connection and basic operations
  - [ ] Test User model CRUD operations
  - [ ] Test Watchlist and WatchlistStock model operations

## Dev Notes

### Previous Story Insights
[Source: Story 1.6 Dev Agent Record]
- The project uses a comprehensive tech stack with Next.js 15, TypeScript, tRPC, and Prisma
- Current development follows strict type safety and coding standards
- Multi-tier caching and performance optimization patterns are established
- Testing strategy uses Vitest and React Testing Library

### Data Models & Database Schema
[Source: architecture/5-data-models-database-schema.md]
- **Current Schema**: The existing Prisma schema already includes comprehensive User, Watchlist, and WatchlistStock models
- **Schema Discrepancy**: Epic specifies single `WatchlistItem` table, but current schema uses `Watchlist` + `WatchlistStock` pattern
- **User Model Configuration**: Must align with Supabase's auth.users table using UUID primary keys
- **Database Trigger**: Required to automatically create User records when users sign up via Supabase Auth
- **Connection URLs**: Requires both DATABASE_URL and DIRECT_URL for migrations and connection pooling

### Supabase Authentication Integration
[Source: architecture/7-authentication.md]
- **Client-Server Distinction**: Frontend uses @supabase/ssr for session management
- **Backend Database Access**: tRPC procedures use Prisma client with direct database connection
- **Auth Flow**: One-time code via email using Supabase Auth
- **Session Management**: Cookie-based sessions handled by Supabase client
- **Database Sync**: Database trigger ensures User records sync with auth.users table

### Technology Stack Requirements
[Source: architecture/3-tech-stack.md]
- **Database**: PostgreSQL 15.x via Supabase
- **ORM**: Prisma 6.15.x for type-safe database operations
- **Authentication**: Supabase Auth latest version
- **Framework**: Next.js 15.x with TypeScript 5.x
- **Package Manager**: pnpm with workspace configuration

### Project Structure Alignment
[Source: architecture/4-monorepo-project-structure.md]
- **Database Package**: `packages/db/` contains Prisma schema and generated client
- **Schema Location**: `packages/db/prisma/schema.prisma`
- **Migration Location**: `packages/db/prisma/migrations/`
- **Generated Client**: Output to `packages/db/src/generated/` directory
- **Server Integration**: Accessed via `apps/web/src/server/db.ts`

### Coding Standards Requirements
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety**: All database operations must be explicitly typed
- **Environment Variables**: Access through centralized configuration, never direct process.env
- **Database Operations**: All interactions through Prisma client only, no raw SQL
- **Error Handling**: Structured error handling in tRPC procedures
- **YAGNI Principle**: Remove unused models or fields not required for current functionality

### Testing Requirements
[Source: architecture/9-testing-strategy.md]
- **Integration Tests**: Test tRPC procedures with Prisma client interactions
- **Database Mocking**: Use mocking for database operations in tests
- **Test Location**: Database tests in appropriate test directories
- **Unit Tests**: Test individual database operations and model validations
- **Test Framework**: Vitest for all database operation testing

### Project Structure Notes
Current Prisma schema already includes comprehensive models beyond Epic requirements:
- User model with watchlist relations
- Watchlist model with user relation and stock items
- WatchlistStock model for individual stock entries

This implementation is more robust than the Epic's simple WatchlistItem approach.

## Testing
[Source: architecture/9-testing-strategy.md]

**Integration Test Requirements:**
- Test database connection establishment with Supabase
- Verify Prisma client generation and functionality
- Test User model CRUD operations with proper UUID handling
- Test Watchlist and WatchlistStock model relationships
- Verify database trigger functionality for User sync
- Test migration application and schema validation

**Unit Test Coverage:**
- Database connection configuration
- Prisma schema validation
- Environment variable configuration
- Model relationship integrity
- Error handling for connection failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation with comprehensive Supabase and database setup context | David Hargitai (dev) |