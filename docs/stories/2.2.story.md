# Story 2.2: Implement User Sign-Up/Login Flow

## Status
Approved

## Story
**As a** User,
**I want** a simple and secure way to log in with my email,
**so that** I can access features like the watchlist.

## Acceptance Criteria
1. A login page/modal is created.
2. Users can enter their email to receive a one-time login code from Supabase Auth.
3. Users can enter the received code to complete the login process.
4. Client-side session management is handled using the Supabase client library.
5. A "Logout" button is available for authenticated users.

## Tasks / Subtasks
- [ ] Create LoginForm component with OTP flow (AC: 1, 2, 3)
  - [ ] Create `apps/web/src/components/auth/LoginForm.tsx` as Client Component
  - [ ] Implement email input form with validation
  - [ ] Integrate Supabase Auth `signInWithOtp()` method
  - [ ] Implement OTP verification form with `verifyOtp()` method
  - [ ] Add loading states and error handling for auth flows
  - [ ] Style with DaisyUI components (input, button, modal classes)
- [ ] Create authentication context/state management (AC: 4)
  - [ ] Set up Supabase client using `@supabase/ssr` package in `apps/web/src/lib/supabase.ts`
  - [ ] Create authentication hooks for session state management
  - [ ] Implement session persistence across page refreshes
  - [ ] Handle authentication state changes and user session updates
- [ ] Integrate login flow into application navigation (AC: 1, 5)
  - [ ] Update Navbar component to show Login button for guests
  - [ ] Add Login link/button that opens LoginForm modal or navigates to login page
  - [ ] Implement Logout button for authenticated users
  - [ ] Update navigation state based on authentication status
- [ ] Implement redirect logic after authentication (AC: 4)
  - [ ] Redirect users back to previous page after successful login
  - [ ] Handle authentication state in protected routes
  - [ ] Implement session validation for client-side routing
- [ ] Write comprehensive tests for authentication flow
  - [ ] Unit tests for LoginForm component interactions
  - [ ] Integration tests for Supabase Auth flow
  - [ ] Test error scenarios (invalid email, expired OTP, network errors)
  - [ ] Test session management and persistence

## Dev Notes

### Previous Story Insights
[Source: Story 2.1 Dev Agent Record]
- Database is configured with UUID-based User model for Supabase Auth compatibility
- Database trigger automatically creates User records when users sign up through Supabase Auth
- Environment variables properly configured for Supabase connection
- tRPC routers updated to support UUID-based user identification

### Authentication Architecture
[Source: architecture/7-authentication.md]
- **Client-Side Authentication**: Use `@supabase/ssr` package for cookie-based session management in Next.js
- **Server-Side Operations**: tRPC API routes use Prisma with service-based database connection (not cookie-based client)
- **Critical Distinction**: Frontend uses cookie-based Supabase client for auth, backend uses Prisma with service role credentials for database operations
- **Authentication Flow**: Email OTP (one-time password) via Supabase Auth
- **Session Management**: Cookie-based sessions handled by Supabase client for frontend, tRPC `protectedProcedure` verifies sessions for backend
- **Login Sequence**: 
  1. User enters email → `supabase.auth.signInWithOtp()`
  2. Supabase sends OTP to email → User enters code
  3. `supabase.auth.verifyOtp()` → Returns session + sets auth cookie

### Component Architecture
[Source: architecture/frontend-architecture.md#5-component-inventory]
- **LoginForm**: Modal or page for email code authentication flow (Client Component required)
- **Component Interaction Pattern**: LoginForm integrates with Navbar for authentication state
- **User Flow**: Stock Detail Page → Login to Add to Watchlist → Login Page → Redirect back after auth

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- Authentication components: `apps/web/src/components/auth/`
- Supabase client setup: `apps/web/src/lib/supabase.ts`
- Client-side helpers: `apps/web/src/lib/` directory
- Next.js pages: `apps/web/src/app/` (App Router structure)

### Technical Constraints
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Client Component Requirements**: LoginForm must be marked with `'use client'` due to form interactions and hooks
- **Component Boundary**: Keep `'use client'` boundary minimal - only interactive auth components
- **State Management**: Keep authentication state at component level, don't lift unnecessarily to page level
- **Styling**: Use only DaisyUI and TailwindCSS classes, no inline styles
- **Type Safety**: All functions must have explicit types, no `any` type allowed
- **Environment Variables**: Access through centralized configuration module

### Testing Requirements
[Source: architecture/9-testing-strategy.md]
- **Unit Tests**: LoginForm component interactions using Vitest and React Testing Library
- **Integration Tests**: Supabase Auth flow integration with mocking for external auth service
- **Test Coverage**: Form validation, OTP flow, session management, error handling
- **Test Framework**: Vitest for all frontend component testing

### UI/UX Requirements
[Source: architecture/frontend-architecture.md#3-user-flows]
- **Login Page Access**: Via "Login" button in navigation or "Login to Add to Watchlist" on Stock Detail Page
- **OTP Flow**: Email input → Send Code → Code verification → Redirect to origin page
- **Navigation State**: Show "Login/Watchlist" for guests, "Logout/Search" for authenticated users

### Project Structure Notes
Authentication implementation follows Next.js App Router architecture with clear separation between:
- Server Components: Navbar, pages, static UI elements
- Client Components: LoginForm, interactive authentication elements
- Shared utilities: Supabase client configuration in lib directory

## Testing
[Source: architecture/9-testing-strategy.md]

**Unit Test Requirements:**
- LoginForm component rendering and user interactions
- Form validation for email input
- OTP verification form functionality
- Error state handling and display
- Loading state management during auth operations

**Integration Test Requirements:**
- Complete email OTP authentication flow
- Session management and persistence
- Authentication state changes
- Redirect logic after successful authentication
- Logout functionality

**Test Framework and Location:**
- **Test Framework**: Vitest with React Testing Library
- **Test Location**: `apps/web/src/components/auth/__tests__/`
- **Mocking Strategy**: Mock Supabase Auth service for predictable test scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation with comprehensive authentication context from architecture docs | David Hargitai (dev) |