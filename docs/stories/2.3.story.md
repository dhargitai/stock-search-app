# Story 2.3: Create tRPC API Endpoints for Watchlist

## Status
Approved

## Story
**As a** Developer,
**I want** a secure, type-safe API for managing watchlist items,
**so that** the frontend can interact with the database.

## Acceptance Criteria
1. A protected tRPC router is created that requires user authentication.
2. An endpoint `getWatchlist` is created to fetch all stocks for the logged-in user.
3. An endpoint `addToWatchlist` is created to add a stock symbol to the user's watchlist.
4. An endpoint `removeFromWatchlist` is created to remove a stock symbol from the user's watchlist.
5. The endpoints use Prisma to interact with the database.

## Tasks / Subtasks
- [ ] Create protectedProcedure middleware in tRPC (AC: 1)
  - [ ] Update `apps/web/src/server/api/trpc.ts` to add authentication middleware
  - [ ] Integrate with Supabase session verification from Story 2.2
  - [ ] Add proper error handling for unauthenticated requests
  - [ ] Extract user ID from authenticated session context
- [ ] Implement watchlist tRPC router (AC: 2, 3, 4, 5)
  - [ ] Create `apps/web/src/server/api/routers/watchlist.ts` with protected procedures
  - [ ] Implement `get` procedure to fetch user's watchlist items using Prisma
  - [ ] Implement `add` mutation to create new watchlist items with duplicate prevention
  - [ ] Implement `remove` mutation to delete watchlist items
  - [ ] Add proper Zod input validation for all endpoints
  - [ ] Include comprehensive error handling for database operations
- [ ] Update tRPC root router (AC: 1)
  - [ ] Add watchlist router to `apps/web/src/server/api/root.ts`
  - [ ] Export watchlist procedures for frontend consumption
- [ ] Write comprehensive tests
  - [ ] Create `apps/web/src/server/api/routers/__tests__/watchlist.test.ts`
  - [ ] Test all endpoints with authenticated and unauthenticated scenarios
  - [ ] Test database operations and error handling
  - [ ] Test input validation and edge cases

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 Dev Agent Record]
- Authentication system fully implemented with Supabase Auth using OTP email flow
- Session management handled via `@supabase/ssr` with cookie-based authentication
- Server-side Supabase client configured in `apps/web/src/lib/supabase/server.ts`
- Middleware configured in `apps/web/middleware.ts` for session handling
- User authentication state available through hooks and server context
- Database has User model with UUID primary key matching Supabase auth.users

### Authentication Architecture
[Source: architecture/7-authentication.md]
- **Critical Distinction**: Frontend uses cookie-based Supabase client for auth, backend uses Prisma with service role credentials for database operations
- **tRPC Protected Procedures**: Must verify user sessions from Supabase Auth cookies
- **Session Verification**: Use server-side Supabase client to validate auth cookies and extract user information
- **Database Access**: tRPC procedures use Prisma client directly with service-based database connection
- **User Context**: Extract `user.id` from verified Supabase session for database operations

### API Specifications
[Source: architecture/6-api-specification-trpc.md]
- **Watchlist Router File**: `apps/web/src/server/api/routers/watchlist.ts`
- **Protected Procedures Required**: All watchlist operations require authentication
- **Endpoint Specifications**:
  - `get`: Returns `WatchlistItem[]` for authenticated user
  - `add`: Accepts `{ symbol: string }`, creates watchlist item
  - `remove`: Accepts `{ symbol: string }`, deletes watchlist item
- **Database Integration**: Use `ctx.prisma.watchlistItem` for all operations
- **Input Validation**: Use Zod schemas for all procedure inputs

### Data Models
[Source: architecture/5-data-models-database-schema.md]
- **WatchlistItem Model**: `{ id: Int, symbol: String, createdAt: DateTime, userId: String, user: User }`
- **Unique Constraint**: `@@unique([userId, symbol])` prevents duplicate watchlist entries
- **User Relationship**: `user: User @relation(fields: [userId], references: [id], onDelete: Cascade)`
- **Database Operations**: Use Prisma client methods: `findMany`, `create`, `delete`

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- **tRPC Setup**: `apps/web/src/server/api/trpc.ts` - Main tRPC configuration
- **API Routers**: `apps/web/src/server/api/routers/` - Individual router files
- **Root Router**: `apps/web/src/server/api/root.ts` - Main router aggregation
- **Database Client**: Access via `@peak-finance/db` package import

### Technical Constraints
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety**: All functions must have explicit types, no `any` type allowed
- **Database Interaction**: All database operations must go through Prisma client, no raw SQL
- **Error Handling**: All tRPC procedures must include structured error handling with specific tRPC error codes
- **Environment Variables**: Access only through centralized configuration, never `process.env` directly
- **Input Validation**: Use Zod schemas for all procedure inputs

### tRPC Context Integration
[Source: Current tRPC setup in apps/web/src/server/api/trpc.ts]
- **Current Context**: `{ db: typeof db, req: Request }`
- **Authentication Extension Needed**: Add user session information to context for protected procedures
- **Middleware Pattern**: Create middleware to verify Supabase session and inject user data
- **Database Access**: Context already includes `db` (Prisma client) for database operations

### Project Structure Notes
Authentication integration follows tRPC middleware pattern with clear separation:
- **Public Procedures**: Available without authentication (existing stock endpoints)
- **Protected Procedures**: Require valid Supabase session with user context
- **Database Operations**: Use existing Prisma client from context for all watchlist operations
- **Session Validation**: Leverage server-side Supabase client from Story 2.2 implementation

## Testing
[Source: architecture/9-testing-strategy.md]

**Unit Test Requirements:**
- Individual tRPC procedure testing with mocked dependencies
- Input validation testing with various data scenarios
- Error handling verification for database and authentication failures

**Integration Test Requirements:**
- End-to-end testing of authentication flow through tRPC procedures
- Database interaction testing with Prisma client
- Session management and user context validation
- Protected procedure authorization verification

**Test Framework and Location:**
- **Test Framework**: Vitest for server-side tRPC procedure testing
- **Test Location**: `apps/web/src/server/api/routers/__tests__/watchlist.test.ts`
- **Mocking Strategy**: Mock Prisma client and Supabase session verification for predictable test scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation for tRPC watchlist API endpoints with comprehensive authentication and database integration context | David Hargitai (dev) |