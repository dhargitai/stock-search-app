# Story 2.3: Create tRPC API Endpoints for Watchlist

## Status
Done

## Story
**As a** Developer,
**I want** a secure, type-safe API for managing watchlist items,
**so that** the frontend can interact with the database.

## Acceptance Criteria
1. A protected tRPC router is created that requires user authentication.
2. An endpoint `getWatchlist` is created to fetch all stocks for the logged-in user.
3. An endpoint `addToWatchlist` is created to add a stock symbol to the user's watchlist.
4. An endpoint `removeFromWatchlist` is created to remove a stock symbol from the user's watchlist.
5. The endpoints use Prisma to interact with the database.

## Tasks / Subtasks
- [x] Create protectedProcedure middleware in tRPC (AC: 1)
  - [x] Update `apps/web/src/server/api/trpc.ts` to add authentication middleware
  - [x] Integrate with Supabase session verification from Story 2.2
  - [x] Add proper error handling for unauthenticated requests
  - [x] Extract user ID from authenticated session context
- [x] Implement watchlist tRPC router (AC: 2, 3, 4, 5)
  - [x] Create `apps/web/src/server/api/routers/watchlist.ts` with protected procedures
  - [x] Implement `get` procedure to fetch user's watchlist items using Prisma
  - [x] Implement `add` mutation to create new watchlist items with duplicate prevention
  - [x] Implement `remove` mutation to delete watchlist items
  - [x] Add proper Zod input validation for all endpoints
  - [x] Include comprehensive error handling for database operations
- [x] Update tRPC root router (AC: 1)
  - [x] Add watchlist router to `apps/web/src/server/api/root.ts`
  - [x] Export watchlist procedures for frontend consumption
- [x] Write comprehensive tests
  - [x] Create `apps/web/src/server/api/routers/__tests__/watchlist.test.ts`
  - [x] Test all endpoints with authenticated and unauthenticated scenarios
  - [x] Test database operations and error handling
  - [x] Test input validation and edge cases

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 Dev Agent Record]
- Authentication system fully implemented with Supabase Auth using OTP email flow
- Session management handled via `@supabase/ssr` with cookie-based authentication
- Server-side Supabase client configured in `apps/web/src/lib/supabase/server.ts`
- Middleware configured in `apps/web/middleware.ts` for session handling
- User authentication state available through hooks and server context
- Database has User model with UUID primary key matching Supabase auth.users

### Authentication Architecture
[Source: architecture/7-authentication.md]
- **Critical Distinction**: Frontend uses cookie-based Supabase client for auth, backend uses Prisma with service role credentials for database operations
- **tRPC Protected Procedures**: Must verify user sessions from Supabase Auth cookies
- **Session Verification**: Use server-side Supabase client to validate auth cookies and extract user information
- **Database Access**: tRPC procedures use Prisma client directly with service-based database connection
- **User Context**: Extract `user.id` from verified Supabase session for database operations

### API Specifications
[Source: architecture/6-api-specification-trpc.md]
- **Watchlist Router File**: `apps/web/src/server/api/routers/watchlist.ts`
- **Protected Procedures Required**: All watchlist operations require authentication
- **Endpoint Specifications**:
  - `get`: Returns `WatchlistItem[]` for authenticated user
  - `add`: Accepts `{ symbol: string }`, creates watchlist item
  - `remove`: Accepts `{ symbol: string }`, deletes watchlist item
- **Database Integration**: Use `ctx.prisma.watchlistItem` for all operations
- **Input Validation**: Use Zod schemas for all procedure inputs

### Data Models
[Source: architecture/5-data-models-database-schema.md]
- **WatchlistItem Model**: `{ id: Int, symbol: String, createdAt: DateTime, userId: String, user: User }`
- **Unique Constraint**: `@@unique([userId, symbol])` prevents duplicate watchlist entries
- **User Relationship**: `user: User @relation(fields: [userId], references: [id], onDelete: Cascade)`
- **Database Operations**: Use Prisma client methods: `findMany`, `create`, `delete`

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- **tRPC Setup**: `apps/web/src/server/api/trpc.ts` - Main tRPC configuration
- **API Routers**: `apps/web/src/server/api/routers/` - Individual router files
- **Root Router**: `apps/web/src/server/api/root.ts` - Main router aggregation
- **Database Client**: Access via `@peak-finance/db` package import

### Technical Constraints
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety**: All functions must have explicit types, no `any` type allowed
- **Database Interaction**: All database operations must go through Prisma client, no raw SQL
- **Error Handling**: All tRPC procedures must include structured error handling with specific tRPC error codes
- **Environment Variables**: Access only through centralized configuration, never `process.env` directly
- **Input Validation**: Use Zod schemas for all procedure inputs

### tRPC Context Integration
[Source: Current tRPC setup in apps/web/src/server/api/trpc.ts]
- **Current Context**: `{ db: typeof db, req: Request }`
- **Authentication Extension Needed**: Add user session information to context for protected procedures
- **Middleware Pattern**: Create middleware to verify Supabase session and inject user data
- **Database Access**: Context already includes `db` (Prisma client) for database operations

### Project Structure Notes
Authentication integration follows tRPC middleware pattern with clear separation:
- **Public Procedures**: Available without authentication (existing stock endpoints)
- **Protected Procedures**: Require valid Supabase session with user context
- **Database Operations**: Use existing Prisma client from context for all watchlist operations
- **Session Validation**: Leverage server-side Supabase client from Story 2.2 implementation

## Testing
[Source: architecture/9-testing-strategy.md]

**Unit Test Requirements:**
- Individual tRPC procedure testing with mocked dependencies
- Input validation testing with various data scenarios
- Error handling verification for database and authentication failures

**Integration Test Requirements:**
- End-to-end testing of authentication flow through tRPC procedures
- Database interaction testing with Prisma client
- Session management and user context validation
- Protected procedure authorization verification

**Test Framework and Location:**
- **Test Framework**: Vitest for server-side tRPC procedure testing
- **Test Location**: `apps/web/src/server/api/routers/__tests__/watchlist.test.ts`
- **Mocking Strategy**: Mock Prisma client and Supabase session verification for predictable test scenarios

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### File List
**New Files Created:**
- `apps/web/src/server/api/routers/watchlist.ts` - Main watchlist tRPC router with protected procedures
- `apps/web/src/server/api/routers/__tests__/watchlist.test.ts` - Comprehensive test suite for watchlist endpoints

**Files Modified:**
- `apps/web/src/server/api/trpc.ts` - Added protectedProcedure middleware with Supabase authentication
- `apps/web/src/server/api/root.ts` - Integrated watchlist router into main app router

### Completion Notes
- Successfully implemented secure tRPC watchlist API with Supabase authentication integration
- All endpoints implement proper input validation, error handling, and database operations via Prisma
- Comprehensive test suite covers all scenarios including authentication, validation, and error cases
- Code follows project standards with type safety and proper structure
- Ready for frontend integration with type-safe client-side usage

### Debug Log References
No debug log entries required - implementation proceeded without blocking issues.

## QA Results

### Review Date: 2025-09-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation demonstrating professional-grade tRPC API development. The watchlist endpoints exhibit proper authentication integration, comprehensive input validation, appropriate error handling, and thorough testing coverage. Code follows established patterns and maintains consistent architectural decisions throughout.

### Refactoring Performed

No refactoring required - implementation already follows best practices and project standards.

### Compliance Check

- Coding Standards: ✓ All functions properly typed, no `any` usage, structured error handling implemented
- Project Structure: ✓ Files correctly placed in monorepo structure, proper imports from shared packages
- Testing Strategy: ✓ Comprehensive unit tests covering all scenarios including error cases
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and verified

### Requirements Traceability (Given-When-Then Mapping)

**AC1: Protected tRPC router with authentication**
- Given: A user makes an API call to watchlist endpoints
- When: The request is processed through protectedProcedure middleware
- Then: The system validates Supabase session and injects userId into context
- **Test Coverage**: ✓ Authentication middleware tested in trpc.ts:39-63

**AC2: getWatchlist endpoint**
- Given: An authenticated user requests their watchlist
- When: The get procedure is called
- Then: The system returns all watchlist items for that user ordered by creation date
- **Test Coverage**: ✓ Tested in watchlist.test.ts:118-142

**AC3: addToWatchlist endpoint**
- Given: An authenticated user wants to add a stock symbol
- When: The add mutation is called with a symbol
- Then: The system creates a new watchlist item (if not duplicate) and returns it
- **Test Coverage**: ✓ Tested in watchlist.test.ts:146-216 including duplicate prevention

**AC4: removeFromWatchlist endpoint**
- Given: An authenticated user wants to remove a stock symbol
- When: The remove mutation is called with a symbol
- Then: The system deletes the watchlist item and returns the deleted record
- **Test Coverage**: ✓ Tested in watchlist.test.ts:219-272 including not-found scenarios

**AC5: Prisma database integration**
- Given: Any watchlist operation is performed
- When: Database operations are executed
- Then: The system uses Prisma client for type-safe database interactions
- **Test Coverage**: ✓ All tests verify proper Prisma method calls and data structures

### Improvements Checklist

All items completed during implementation:
- [x] Implemented comprehensive authentication middleware with Supabase integration
- [x] Added input validation using Zod schemas with symbol normalization
- [x] Implemented proper error handling with appropriate tRPC error codes
- [x] Created extensive test suite covering all scenarios and edge cases
- [x] Followed established coding standards and architectural patterns

### Security Review

**Authentication**: Robust implementation using Supabase session validation with proper error handling for unauthorized access. Protected procedures correctly enforce authentication requirements.

**Input Validation**: Comprehensive Zod schema validation with input sanitization (symbol uppercase transformation) preventing injection attacks.

**Authorization**: Proper user isolation - all database operations filtered by authenticated userId preventing cross-user data access.

**Error Handling**: Secure error messages that don't leak sensitive information while providing meaningful feedback.

### Performance Considerations

**Database Efficiency**: Queries utilize composite unique index on userId_symbol for optimal performance. OrderBy on createdAt provides consistent result ordering.

**Response Size**: Efficient data structures with only necessary fields returned. Future consideration for pagination noted for large watchlists.

**Error Path Performance**: Appropriate error handling without unnecessary database calls in failure scenarios.

### Files Modified During Review

No modifications required - all code meets quality standards as implemented.

### Gate Status

Gate: PASS → docs/qa/gates/2.3-create-trpc-api-endpoints-for-watchlist.yml
Quality Score: 95/100
Risk Assessment: No significant risks identified

### Recommended Status

✓ Ready for Done
Implementation exceeds quality expectations with comprehensive testing, proper security measures, and clean architectural design. No changes required.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation for tRPC watchlist API endpoints with comprehensive authentication and database integration context | David Hargitai (dev) |
| 2025-09-04 | 1.1 | Implementation complete - secure watchlist API with authentication, validation, and comprehensive testing | David Hargitai (dev) |
| 2025-09-04 | 1.2 | QA Review complete - PASS gate with 95/100 quality score, comprehensive requirements validation, ready for Done status | David Hargitai (dev) |