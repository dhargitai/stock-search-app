# Story 1.5: Integrate Alphavantage APIs for Stock Details

## Status
Approved

## Story
**As a** User,
**I want** to see the latest price and historical data for a stock,
**so that** I can make informed decisions.

## Acceptance Criteria
1. When the detail page loads, it uses SSR to fetch data for the given symbol.
2. tRPC endpoints are created to fetch data from the Alphavantage `GLOBAL_QUOTE` and `TIME_SERIES_DAILY_ADJUSTED` APIs.
3. The key quote data section is populated with the results from `GLOBAL_QUOTE`.
4. The historical data is passed to the chart component.

## Tasks / Subtasks
- [ ] Create tRPC procedures for Alphavantage API integration (AC: 2)
  - [ ] Implement `getGlobalQuote` procedure to fetch GLOBAL_QUOTE data from Alphavantage
  - [ ] Implement `getTimeSeriesDaily` procedure to fetch TIME_SERIES_DAILY_ADJUSTED data
  - [ ] Add proper input validation with Zod schemas for stock symbol
  - [ ] Include error handling for API failures and rate limiting
  - [ ] Add TypeScript interfaces for API response data
- [ ] Integrate stock data fetching with stock detail page (AC: 1, 3)
  - [ ] Modify `/[symbol]/page.tsx` to use Server-Side Rendering with tRPC API calls
  - [ ] Update StockQuoteCard component to accept and display real quote data
  - [ ] Handle loading states during SSR data fetching
  - [ ] Implement error boundaries for API failure scenarios
- [ ] Prepare historical data for chart component integration (AC: 4)
  - [ ] Process TIME_SERIES_DAILY_ADJUSTED data into chart-ready format
  - [ ] Pass formatted historical data to PriceChartContainer component
  - [ ] Ensure data transformation follows Apache ECharts expected format
- [ ] Add comprehensive error handling and user feedback
  - [ ] Display meaningful error messages for invalid stock symbols
  - [ ] Handle API rate limit scenarios gracefully
  - [ ] Add fallback states when data is unavailable
- [ ] Write unit and integration tests for tRPC procedures
  - [ ] Test API endpoints with mock Alphavantage responses
  - [ ] Test error scenarios and edge cases
  - [ ] Test data transformation logic
  - [ ] Test Server-Side Rendering integration

## Dev Notes

### Previous Story Insights
[Source: Story 1.4 Dev Agent Record]
- Stock detail page layout is complete with `/[symbol]/page.tsx` route established
- StockQuoteCard component exists and ready for real data integration
- PriceChartContainer component prepared for Apache ECharts integration
- Page structure uses Server Component architecture with proper TypeScript interfaces
- DaisyUI styling patterns established for consistent quote data display
- Responsive design implemented and tested across all breakpoints

### Tech Stack Requirements
[Source: architecture/3-tech-stack.md]
- **API Layer**: tRPC 11.x - End-to-end type safety between server and client
- **Framework**: Next.js 15 App Router - Server-Side Rendering for stock data
- **Language**: TypeScript 5.x - Strict type safety enforcement required
- **Client State**: React Query 5.x - Server state management and caching
- **Database**: PostgreSQL with Prisma 6.15.x - Type-safe ORM for data operations

### API Specifications
[Source: architecture/6-api-specification-trpc.md]
- **Stock Router File**: `apps/web/src/server/api/routers/stock.ts`
- **Required tRPC Procedures**:
  - `getDetails` procedure with symbol input validation
  - Must call Alphavantage GLOBAL_QUOTE and TIME_SERIES_DAILY_ADJUSTED APIs
  - Return combined quote and historical data
- **Input Validation**: Use Zod schema `z.object({ symbol: z.string().min(1) })`
- **Procedure Type**: `publicProcedure` (no authentication required)

### Alphavantage API Integration Details
[Source: External API requirements from AC]
- **GLOBAL_QUOTE API**: Real-time stock quote data (price, change, open, high, low, volume)
- **TIME_SERIES_DAILY_ADJUSTED API**: Historical daily price data for charting
- **API Key**: Access via environment variables through centralized config
- **Rate Limiting**: Alphavantage has request rate limits that must be handled
- **Error Handling**: API may return error responses for invalid symbols

### Data Models and TypeScript Interfaces
Based on Alphavantage API responses, define:
- `GlobalQuoteResponse`: Raw API response from GLOBAL_QUOTE
- `TimeSeriesResponse`: Raw API response from TIME_SERIES_DAILY_ADJUSTED  
- `StockQuoteData`: Processed quote data for StockQuoteCard component
- `ChartDataPoint`: Formatted historical data points for Apache ECharts
- `StockDetailsData`: Combined interface for page props

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- **tRPC Router**: `apps/web/src/server/api/routers/stock.ts` (enhance existing)
- **Stock Detail Page**: `apps/web/src/app/[symbol]/page.tsx` (modify for SSR)
- **Type Definitions**: Consider `apps/web/src/lib/types/stock.ts` for shared interfaces
- **Test Files**: `apps/web/src/server/api/routers/__tests__/stock.test.ts`

### Coding Standards Requirements
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety**: All API responses and data transformations must have explicit TypeScript types
- **Environment Variables**: Use centralized configuration, never access `process.env` directly
- **API Interaction**: All external API calls through tRPC procedures, no direct `fetch` calls
- **Error Handling**: Structured tRPC error handling with specific error codes
- **Server Components**: Stock detail page remains Server Component using SSR data fetching

### Testing Requirements
[Source: architecture/9-testing-strategy.md]
- **Unit Tests**: Test tRPC procedures with mocked Alphavantage API responses
- **Integration Tests**: Test complete data flow from API to component rendering
- **Error Testing**: Test API failures, invalid symbols, and rate limiting scenarios
- **Mock Strategy**: Mock external Alphavantage API calls in test environment

### Project Structure Notes
Current project structure aligns perfectly with requirements. The existing tRPC setup and Server Component architecture provide the foundation for SSR data fetching. The stock detail page components are ready for real data integration.

## Testing
[Source: architecture/9-testing-strategy.md]

**Unit Test Requirements:**
- Test files in `apps/web/src/server/api/routers/__tests__/` directory
- Use Vitest for tRPC procedure testing with mocked external APIs
- Test data transformation logic and TypeScript interface compliance
- Test error scenarios including API failures and invalid symbol responses

**Integration Test Coverage:**
- Complete SSR data flow from tRPC procedures to page rendering
- StockQuoteCard component integration with real API data structure
- PriceChartContainer data format compatibility
- Server-Side Rendering performance and error boundary behavior

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-03 | 1.0 | Initial story creation with comprehensive API integration context | David Hargitai (dev) |