# Story 3.2: Implement Watchlist Page UI

## Status
Ready for Review

## Story
**As an** Authenticated User,
**I want** a dedicated page to view all my saved stocks,
**so that** I can monitor them in one place.

## Acceptance Criteria
1. A protected route `/watchlist` is created, accessible only to authenticated users.
2. The page displays a list or grid of the stocks from the user's watchlist.
3. Each item in the list displays key information (e.g., symbol, name, current price).
4. Clicking on a stock in the watchlist navigates to its detail page.
5. A "Remove" button is present for each stock in the list.

## Tasks / Subtasks
- [x] Create protected watchlist page route (AC: 1)
  - [x] Create `apps/web/src/app/watchlist/page.tsx` as a Server Component 
  - [x] Implement route protection using authentication middleware or redirect logic
  - [x] Add page metadata and SEO information for watchlist page
- [x] Implement page layout and structure (AC: 2)
  - [x] Create page header with "My Watchlist" title and navigation
  - [x] Design responsive grid/list layout for watchlist items
  - [x] Follow DaisyUI component patterns and TailwindCSS styling
- [x] Create WatchlistItem component for individual stock display (AC: 3, 4, 5)
  - [x] Create `apps/web/src/components/ui/watchlist-item.tsx` as client component for interactivity
  - [x] Display stock symbol, company name, current price (placeholder data initially)
  - [x] Implement click navigation to stock detail page (`/[symbol]`)
  - [x] Add "Remove" button with proper styling and accessibility
  - [x] Integrate with existing WatchlistButton component patterns
- [x] Implement page state management (AC: 2)
  - [x] Add loading state while fetching watchlist data
  - [x] Add empty state when user has no watchlist items
  - [x] Add error state for API failures
  - [x] Use proper React Query patterns with tRPC integration

## Dev Notes

### Previous Story Insights
From Story 3.1 implementation:
- WatchlistButton component successfully integrates with tRPC watchlist router
- Authentication patterns established using useAuth hook 
- Optimistic UI updates work well with React Query mutations
- DaisyUI styling patterns established for button components
- Testing patterns established with comprehensive coverage (16 tests)

### Data Models
[Source: architecture/5-data-models-database-schema.md]
**WatchlistItem Model:**
```typescript
model WatchlistItem {
  id        Int      @id @default(autoincrement())
  symbol    String
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, symbol])
}
```
- Primary composite key on `userId_symbol` for efficient queries
- Cascade delete ensures cleanup when user is deleted
- `createdAt` timestamp allows ordering by recently added items

### API Specifications
[Source: architecture/6-api-specification-trpc.md]
**Existing Watchlist tRPC Router Endpoints:**
- `api.watchlist.get.useQuery()` - Returns WatchlistItem[] for authenticated user
- `api.watchlist.remove.useMutation()` - Removes item from watchlist
- All endpoints use `protectedProcedure` with authentication middleware
- Endpoints include comprehensive error handling with tRPC error codes

### Component Specifications
[Source: architecture/frontend-architecture.md]
**Component Inventory Requirements:**
- **WatchlistItem**: Single row component displaying stock info with remove functionality
- Follow established patterns from existing components (SearchInput, WatchlistButton)

**UI/UX Wireframe Reference:**
```
+-----------------------------------------------------------------+
| Peak Finance                                   [Logout] [Search] |
+-----------------------------------------------------------------+
|                                                                 |
|  My Watchlist                                                   |
|  =============================================================  |
|  +-----------------------------------------------------------+  |
|  | Apple Inc. (AAPL)      $175.50 +1.21%  [Remove] |  |
|  +-----------------------------------------------------------+  |
|  | Microsoft Corp (MSFT)  $310.20 -0.55%   [Remove] |  |
|  +-----------------------------------------------------------+  |
```

**Empty State Pattern:**
```
|           Your watchlist is empty.                              |
|           Search for stocks to add them to your list.           |
|                        [Find Stocks]                            |
```

### File Locations
[Source: architecture/4-monorepo-project-structure.md]
- **Page Route**: `apps/web/src/app/watchlist/page.tsx` - Next.js 15 App Router page
- **Component**: `apps/web/src/components/ui/watchlist-item.tsx` - Reusable UI component
- **Test Files**: `apps/web/src/components/ui/__tests__/watchlist-item.test.tsx`

### Technical Constraints
[Source: architecture/10-coding-standards-for-ai-agents.md]
- **Type Safety**: All functions/variables must have explicit types, no `any` type
- **tRPC Integration**: Use only tRPC hooks for data fetching (`api.watchlist.get.useQuery`)
- **Component Architecture**: Page is Server Component, interactive elements are Client Components
- **Client Boundary Minimization**: Only mark smallest necessary components with `'use client'`
- **Styling**: Use only DaisyUI and TailwindCSS classes, no inline styles or custom CSS

**Tech Stack Constraints:**
[Source: architecture/3-tech-stack.md]
- **Framework**: Next.js 15 App Router
- **Language**: TypeScript 5.x
- **Styling**: TailwindCSS 4.x + DaisyUI 5.1.x
- **State Management**: React Query 5.x via tRPC integration

### Authentication Requirements
[Source: architecture/7-authentication.md]
- Page must be protected, accessible only to authenticated users
- Use Supabase Auth via `@supabase/ssr` cookie-based client
- Follow established authentication patterns from existing protected routes
- Server-side session verification for route protection

### Testing Requirements
[Source: architecture/9-testing-strategy.md]
- **Testing Framework**: Vitest with React Testing Library for component tests  
- **Test Location**: `apps/web/src/components/ui/__tests__/watchlist-item.test.tsx`
- **Mocking Strategy**: Mock tRPC hooks and useAuth hook for isolated component testing
- **Test Coverage**: Test all component states (loading, populated, empty, error)

### Specific Testing Requirements for This Story
- Test page renders correctly for authenticated users with populated watchlist
- Test empty state display when user has no watchlist items
- Test loading state while fetching watchlist data
- Test error state handling for API failures
- Test navigation to stock detail pages when items are clicked
- Test remove button functionality with optimistic UI updates
- Test responsive layout on different screen sizes
- Mock `api.watchlist.get.useQuery` to return test data scenarios
- Mock `api.watchlist.remove.useMutation` for remove button testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation | David Hargitai (dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes List
- Successfully implemented protected watchlist page with server-side authentication
- Created responsive WatchlistItem component using DaisyUI list component patterns
- Implemented comprehensive error handling, loading, and empty states
- All acceptance criteria met with proper accessibility and styling
- 51 comprehensive tests written covering all component states and edge cases
- All tests passing, lint clean, type checking successful, build successful

### File List
- `apps/web/src/app/watchlist/page.tsx` - Protected watchlist page (Server Component)
- `apps/web/src/components/ui/watchlist-content.tsx` - Client component for watchlist content
- `apps/web/src/components/ui/watchlist-item.tsx` - Individual watchlist item component
- `apps/web/src/components/ui/__tests__/watchlist-item.test.tsx` - WatchlistItem tests (19 tests)
- `apps/web/src/components/ui/__tests__/watchlist-content.test.tsx` - WatchlistContent tests (18 tests)  
- `apps/web/src/app/watchlist/__tests__/page.test.tsx` - Watchlist page tests (14 tests)

## QA Results

### Review Date: September 4, 2025

### Reviewed By: David Hargitai (dev)

### Code Quality Assessment

**Excellent Implementation** - This story demonstrates outstanding adherence to architectural principles and coding standards. The implementation properly separates concerns with Server Components for the page and Client Components only where interactivity is required. TypeScript types are comprehensive throughout, and the code follows established patterns from previous stories.

### Refactoring Performed

No refactoring was required - the code quality exceeded expectations. The implementation demonstrates:
- Proper component separation (Server/Client boundary minimization)
- Comprehensive error handling for all states
- Excellent accessibility with proper ARIA labels
- Optimal DaisyUI component usage
- Clean, maintainable code structure

### Compliance Check

- Coding Standards: ✓ Fully compliant - no `any` types, proper client boundaries, excellent TypeScript usage
- Project Structure: ✓ Files in correct locations per monorepo structure
- Testing Strategy: ✓ Comprehensive test coverage (51 tests) with proper mocking patterns
- All ACs Met: ✓ All acceptance criteria fully implemented and tested

### Improvements Checklist

**All items completed during implementation:**
- [x] Server-side authentication protection implemented (apps/web/src/app/watchlist/page.tsx)
- [x] Responsive design with proper DaisyUI styling (watchlist-content.tsx, watchlist-item.tsx)
- [x] Comprehensive error handling and loading states (all components)
- [x] Optimistic UI updates for remove functionality (watchlist-item.tsx)
- [x] Full accessibility support with ARIA labels (watchlist-item.tsx:64)
- [x] Complete test coverage including edge cases (51 tests across 3 files)
- [x] Proper TypeScript typing throughout (no `any` types found)
- [x] Clean component separation following Next.js 15 patterns

### Security Review

**PASS** - Implementation follows security best practices:
- Server-side session validation prevents unauthorized access
- Proper use of tRPC protected procedures
- No client-side sensitive data exposure
- CSRF protection through Supabase auth integration

### Performance Considerations

**PASS** - Optimized implementation:
- Server Components maximize SSR benefits
- Client boundaries minimized to only interactive elements
- Efficient tRPC queries with proper caching strategy
- Build output shows reasonable bundle sizes (watchlist route: 172 kB first load)

### Files Modified During Review

None - no modifications were necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.2-implement-watchlist-page-ui.yml

### Recommended Status

✓ **Ready for Done** - Implementation exceeds quality standards with comprehensive testing, excellent architecture adherence, and full AC completion.

**Quality Highlights:**
- 92 total tests passing across all watchlist functionality
- Zero linting or TypeScript errors
- Successful production build
- Outstanding code architecture and separation of concerns
- Complete accessibility and responsive design implementation